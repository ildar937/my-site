<script>
  /* === ТВОИ ССЫЛКИ (проверь) === */
  const REPL_HEALTH = "https://280b14e3-c379-4154-8789-7bb7183564fd-00-14ggk3txcbni.riker.replit.dev/health"; // будилка Replit
  const BOT_LINK    = "https://t.me/DoAfterBot";                                                               // основной бот
  const FORM_LINK   = "https://docs.google.com/forms/d/e/1FAIpQLSdR3IK6FcsfUMcjAgzAxcq3jNAsIjtIWzLm8fd8fwVXm-Ay5Q/viewform"; // твоя форма
  /* ================================= */

  // Метка источника (?src=alias => lead_alias)
  const src   = new URLSearchParams(location.search).get("src") || "direct";
  const start = "lead_" + src;

  // Готовим ссылки
  const tgUrl   = BOT_LINK  + "?start=" + encodeURIComponent(start);
  const formUrl = FORM_LINK + (FORM_LINK.includes("?") ? "&" : "?") + "src=" + encodeURIComponent(start);

  // Обновим кнопки на странице (если их показываешь)
  const tgEl   = document.getElementById("tg");
  const formEl = document.getElementById("form");
  const noteEl = document.getElementById("note");
  if (tgEl)   tgEl.href   = tgUrl;
  if (formEl) formEl.href = formUrl;
  if (noteEl) noteEl.textContent = "Источник: " + start;

  // --- НАДЕЖНЫЙ ПРОБУДИТЕЛЬ ---
  async function wake() {
    const url = REPL_HEALTH + (REPL_HEALTH.includes("?") ? "&" : "?") + "ts=" + Date.now();

    // 1) sendBeacon — уходит даже при смене вкладки
    try { if (navigator.sendBeacon) navigator.sendBeacon(url, new Blob([])); } catch(e){}

    // 2) fetch с keepalive — работает при переходе со страницы
    try { await fetch(url, { method:"GET", mode:"no-cors", keepalive:true }); } catch(e){}

    // 3) img-пинг — запасной канал
    try { const i = new Image(); i.src = url; } catch(e){}
  }

  (async () => {
    // Предпрогреем соединение
    try {
      const pre = document.createElement("link");
      pre.rel = "preconnect";
      pre.href = REPL_HEALTH.split("/").slice(0,3).join("/");
      document.head.appendChild(pre);
    } catch(e){}

    // Будим и выдерживаем паузу ~1.3 c, чтобы Replit проснулся
    await wake();
    await new Promise(r => setTimeout(r, 1300));

    // Открываем Телеграм
    location.href = tgUrl;

    // Через 1.6 c откроем резерв-форму в новой вкладке (на случай проблем с Телегой)
    setTimeout(() => { window.open(formUrl, "_blank", "noopener"); }, 1600);
  })();
</script>
